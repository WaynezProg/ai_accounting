name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 允許手動觸發

env:
  GCP_PROJECT_ID: ai-accounting-482914
  GCP_REGION: asia-east1
  CLOUD_RUN_SERVICE: ai-accounting-api
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # =========================
  # 後端部署 (Cloud Run)
  # =========================
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest

    # 只有 backend 目錄有變更才部署
    # 如果想要每次都部署，可以移除這個條件

    permissions:
      contents: read
      id-token: write  # 用於 Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          cd backend
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
            --source . \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --set-secrets "OPENAI_API_KEY=OPENAI_API_KEY:latest,JWT_SECRET_KEY=JWT_SECRET_KEY:latest,GOOGLE_CLIENT_ID=GOOGLE_CLIENT_ID:latest,GOOGLE_CLIENT_SECRET=GOOGLE_CLIENT_SECRET:latest,TURSO_DATABASE_URL=TURSO_DATABASE_URL:latest,TURSO_AUTH_TOKEN=TURSO_AUTH_TOKEN:latest" \
            --set-env-vars "^@^ENV=production@GOOGLE_REDIRECT_URI=https://ai-accounting-api-51386650140.asia-east1.run.app/api/auth/google/callback@FRONTEND_URL=https://frontend-omega-eight-30.vercel.app@CORS_ORIGINS=https://ai-accounting.vercel.app,https://ai-accounting-waynezprog.vercel.app,https://frontend-omega-eight-30.vercel.app"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "Backend URL: $SERVICE_URL"

          # 等待服務啟動
          sleep 10

          # 健康檢查
          response=$(curl -s "$SERVICE_URL/health")
          echo "Health check response: $response"

          if echo "$response" | grep -q "healthy"; then
            echo "✅ Backend deployment successful!"
          else
            echo "❌ Backend health check failed!"
            exit 1
          fi

  # =========================
  # 前端部署 (Vercel)
  # =========================
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel
        id: deploy
        run: |
          cd frontend
          # 直接部署，讓 Vercel 平台處理 build
          url=$(vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }})
          echo "Frontend URL: $url"
          echo "frontend_url=$url" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "✅ Frontend deployed to: ${{ steps.deploy.outputs.frontend_url }}"

  # =========================
  # 部署完成通知
  # =========================
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (Cloud Run) | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (Vercel) | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: https://ai-accounting-api-51386650140.asia-east1.run.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://frontend-omega-eight-30.vercel.app" >> $GITHUB_STEP_SUMMARY
