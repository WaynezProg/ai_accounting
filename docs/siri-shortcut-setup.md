# Siri 捷徑設定教學

本文件說明如何設定 Siri 捷徑，讓你可以用語音快速記帳。

---

## 前置需求

1. iPhone 或 iPad（iOS 12 以上）
2. 捷徑 App（系統內建）
3. API Token（從網頁端取得）
4. 後端 API 網址

---

## 步驟一：取得 API Token

### 方法 A：使用網頁介面（推薦）

1. 開啟網頁應用程式
2. 使用 Google 帳號登入
3. 前往「設定」頁面
4. 點擊「產生 API Token」
5. 複製產生的 Token

**重要**：Token 只會顯示一次，請妥善保管！

### 方法 B：使用 curl 命令（開發測試）

需要先透過網頁登入取得 JWT Token，然後呼叫 API：

```bash
curl -X POST "http://你的API網址/api/auth/token/generate" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"description": "Siri 捷徑"}'
```

回應範例：
```json
{
  "success": true,
  "token": "abcdefg123456...",
  "description": "Siri 捷徑",
  "message": "Token 已產生，請妥善保管"
}
```

---

## 步驟二：建立 Siri 捷徑

### 2.1 開啟捷徑 App

1. 在 iPhone 上開啟「捷徑」App
2. 點擊右上角「+」建立新捷徑

### 2.2 加入「聽寫文字」動作

1. 點擊「加入動作」
2. 搜尋「聽寫」
3. 選擇「聽寫文字」
4. 設定：
   - 停止聆聽：**暫停後**
   - 語言：**中文（台灣）**

### 2.3 加入「取得 URL 內容」動作

1. 搜尋「URL」
2. 選擇「取得 URL 內容」
3. 設定：

**URL**：
```
http://你的API網址/api/accounting/record
```

**方法**：`POST`

**Headers**：
| 欄位 | 值 |
|------|-----|
| Content-Type | application/json |
| Authorization | Bearer 你的Token |

**Request Body**（JSON）：
```json
{
  "text": "聽寫的文字"  ← 這裡要選擇上一步的「聽寫的文字」變數
}
```

### 2.4 加入「取得詞典值」動作（取得回饋）

1. 搜尋「詞典」
2. 選擇「從輸入取得值」
3. 設定 Key 為 `feedback`
4. 如果沒有 feedback，可加入另一個取 `message` 作為備用

### 2.5 加入「朗讀文字」動作

1. 搜尋「朗讀」
2. 選擇「朗讀文字」
3. 輸入：上一步的值（feedback 或 message）

### 2.6 設定捷徑名稱

1. 點擊頂部的捷徑名稱
2. 輸入名稱：**記帳**（或你喜歡的名稱）
3. 點擊「完成」

---

## 步驟三：設定 Siri 語音觸發

1. 在捷徑列表中，長按剛建立的捷徑
2. 選擇「詳細資訊」
3. 點擊「加入到 Siri」
4. 錄製觸發語句，例如：「記一筆帳」

---

## 使用方式

### 方式一：Siri 語音

1. 說「嘿 Siri，記一筆帳」
2. 等待提示後說出記帳內容
3. 例如：「午餐吃滷肉飯 80 元」
4. Siri 會朗讀理財回饋

### 方式二：點擊捷徑

1. 開啟捷徑 App
2. 點擊「記帳」捷徑
3. 說出記帳內容
4. 查看/聽取記帳結果

### 方式三：主畫面 Widget

1. 長按主畫面空白處
2. 點擊「+」新增 Widget
3. 搜尋「捷徑」
4. 加入後選擇「記帳」捷徑

---

## 捷徑完整範例

```
┌─────────────────────────────────────────┐
│  聽寫文字                               │
│  停止聆聽：暫停後                        │
│  語言：中文（台灣）                      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  取得 URL 內容                          │
│  URL: http://xxx/api/accounting/record  │
│  方法: POST                             │
│  Headers:                               │
│    Content-Type: application/json       │
│    Authorization: Bearer xxx            │
│  Body:                                  │
│    {"text": [聽寫的文字]}               │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  從輸入取得值                           │
│  Key: feedback                          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  朗讀文字                               │
│  [從輸入取得的值]                       │
└─────────────────────────────────────────┘
```

---

## 進階設定

### 同時朗讀確認訊息和理財回饋

如果想要同時朗讀確認訊息和理財回饋：

1. 在「取得 URL 內容」後，加入「從輸入取得值」
2. Key 設為 `message`（取得確認訊息）
3. 再加入另一個「從輸入取得值」
4. Key 設為 `feedback`（取得理財回饋）
5. 用「結合文字」合併兩者
6. 朗讀合併後的文字

### 錯誤處理

1. 在「取得 URL 內容」後加入「如果」動作
2. 檢查是否包含 `success`
3. 如果失敗，朗讀錯誤訊息

---

## 常見問題

### Q: 為什麼無法連線？

- 確認 API 網址正確
- 確認後端服務正在運行
- 如果是本地測試，需要使用 ngrok 等工具暴露本地服務

### Q: Token 無效怎麼辦？

- Token 可能已過期或被撤銷
- 前往網頁設定頁面重新產生新的 Token
- 更新捷徑中的 Authorization header

### Q: 語音識別不準確？

- 說話清楚、速度適中
- 避免背景噪音
- 嘗試不同的說法

### Q: 如何測試 API？

使用 curl 測試：

```bash
curl -X POST "http://你的API網址/api/accounting/record" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer 你的Token" \
  -d '{"text": "午餐吃滷肉飯80元"}'
```

### Q: 記帳會寫入哪個 Sheet？

- API Token 綁定用戶帳號
- 使用 Token 記帳會寫入該用戶設定的 Google Sheet
- 可在網頁設定頁面查看或更換 Sheet

---

## API 回應格式

### 成功回應

```json
{
  "success": true,
  "message": "記帳成功",
  "record": {
    "時間": "2024-01-15 12:30",
    "名稱": "滷肉飯",
    "類別": "飲食",
    "花費": 80,
    "幣別": "TWD",
    "支付方式": null
  },
  "feedback": "已記錄午餐 80元。本月飲食類別已消費 3,500元，佔總支出 35%。建議適度控制飲食支出。"
}
```

### 失敗回應

```json
{
  "success": false,
  "error": {
    "code": "PARSE_ERROR",
    "message": "無法解析記帳內容"
  }
}
```

---

## 安全注意事項

1. **不要分享 Token**：Token 相當於密碼
2. **定期更換 Token**：建議每 3-6 個月更換
3. **使用 HTTPS**：生產環境務必使用 HTTPS
4. **管理 Token**：可在網頁設定頁面查看和撤銷 Token

---

## 更新紀錄

- 2024-01-15：初版
- 2025-01：更新 Token 取得方式（需先登入 OAuth）、新增 feedback 欄位說明
